<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Amex Card Usage Pattern Analyzer</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 1600px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            overflow: hidden;
        }
        
        .header {
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
            color: white;
            padding: 40px;
            text-align: center;
        }
        
        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
            font-weight: 300;
        }
        
        .header p {
            font-size: 1.2em;
            opacity: 0.9;
        }
        
        .main-content {
            padding: 40px;
        }
        
        .upload-section {
            background: #f8f9ff;
            border-radius: 15px;
            padding: 30px;
            margin-bottom: 30px;
            border: 2px dashed #4CAF50;
            text-align: center;
            transition: all 0.3s ease;
        }
        
        .upload-section:hover {
            background: #f0f4ff;
            border-color: #2196F3;
        }
        
        .upload-section.dragover {
            background: #e8f5e8;
            border-color: #4CAF50;
            transform: scale(1.02);
        }
        
        #fileInput {
            display: none;
        }
        
        .upload-btn {
            background: linear-gradient(135deg, #4CAF50, #45a049);
            color: white;
            padding: 15px 30px;
            border: none;
            border-radius: 50px;
            cursor: pointer;
            font-size: 1.1em;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(76, 175, 80, 0.3);
        }
        
        .upload-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(76, 175, 80, 0.4);
        }
        
        .config-section {
            background: white;
            border-radius: 12px;
            padding: 25px;
            margin-bottom: 30px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.08);
            border-left: 4px solid #2196F3;
        }
        
        .config-section h3 {
            color: #2196F3;
            margin-bottom: 15px;
            font-size: 1.3em;
        }
        
        .form-group {
            display: inline-block;
            margin-right: 30px;
            margin-bottom: 15px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 500;
            color: #555;
        }
        
        .form-group select {
            padding: 8px 12px;
            border: 2px solid #e0e0e0;
            border-radius: 6px;
            font-size: 14px;
            width: 200px;
        }
        
        .form-group select:focus {
            outline: none;
            border-color: #2196F3;
        }
        
        .analyze-btn {
            background: linear-gradient(135deg, #FF6B35, #F7931E);
            color: white;
            padding: 15px 40px;
            border: none;
            border-radius: 50px;
            cursor: pointer;
            font-size: 1.2em;
            margin: 20px auto;
            display: block;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(255, 107, 53, 0.3);
        }
        
        .analyze-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(255, 107, 53, 0.4);
        }
        
        .analyze-btn:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }
        
        .results-section {
            margin-top: 30px;
        }
        
        .filter-controls-section {
            background: white;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.08);
            border-left: 4px solid #2196F3;
        }
        
        .controls-row {
            display: flex;
            gap: 20px;
            align-items: center;
            margin-bottom: 15px;
            flex-wrap: wrap;
        }
        
        .controls-row:last-child {
            margin-bottom: 0;
            justify-content: space-between;
        }
        
        .control-group {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }
        
        .control-group label {
            font-size: 0.9em;
            font-weight: 600;
            color: #555;
        }
        
        .control-group select, .control-group input {
            padding: 8px 12px;
            border: 2px solid #e0e0e0;
            border-radius: 6px;
            font-size: 14px;
            min-width: 150px;
        }
        
        .control-group select:focus, .control-group input:focus {
            outline: none;
            border-color: #2196F3;
        }
        
        .stats-summary {
            font-weight: 600;
            color: #2196F3;
            font-size: 1.1em;
        }
        
        .filter-btn {
            background: #2196F3;
            color: white;
            padding: 8px 16px;
            border: none;
            border-radius: 20px;
            cursor: pointer;
            font-size: 0.9em;
            transition: all 0.3s ease;
        }
        
        .filter-btn:hover {
            background: #1976D2;
        }
        
        .time-period-tabs {
            display: flex;
            margin-bottom: 20px;
            border-bottom: 2px solid #eee;
        }
        
        .tab {
            padding: 12px 24px;
            background: none;
            border: none;
            cursor: pointer;
            font-size: 1em;
            color: #666;
            border-bottom: 3px solid transparent;
            transition: all 0.3s ease;
        }
        
        .tab.active {
            color: #2196F3;
            border-bottom-color: #2196F3;
            font-weight: 600;
        }
        
        .tab:hover {
            color: #2196F3;
        }
        
        .cards-overview {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .card-summary {
            background: white;
            border-radius: 12px;
            padding: 25px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.08);
            border-left: 4px solid #2196F3;
            position: relative;
            transition: all 0.3s ease;
            cursor: pointer;
        }
        
        .card-summary:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(0,0,0,0.12);
        }
        
        .card-summary.has-anomalies {
            border-left-color: #e74c3c;
        }
        
        .card-summary.no-anomalies {
            border-left-color: #4CAF50;
        }
        
        .card-number {
            font-size: 1.4em;
            font-weight: bold;
            color: #2c3e50;
            margin-bottom: 15px;
        }
        
        .card-stats {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }
        
        .stat-item {
            text-align: center;
            padding: 10px;
            background: #f8f9ff;
            border-radius: 8px;
        }
        
        .stat-value {
            font-size: 1.8em;
            font-weight: bold;
            color: #2196F3;
        }
        
        .stat-label {
            font-size: 0.9em;
            color: #666;
            margin-top: 5px;
        }
        
        .anomaly-indicator {
            position: absolute;
            top: 15px;
            right: 15px;
            background: #e74c3c;
            color: white;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 0.8em;
            font-weight: bold;
        }
        
        .anomaly-indicator.none {
            background: #4CAF50;
        }
        
        .anomalies-section {
            background: white;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 4px 15px rgba(0,0,0,0.08);
            margin-top: 30px;
        }
        
        .section-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
        }
        
        .section-header h3 {
            font-size: 1.5em;
            margin-bottom: 5px;
        }
        
        .anomaly-card {
            padding: 20px;
            border-bottom: 1px solid #eee;
            transition: all 0.3s ease;
            cursor: pointer;
            position: relative;
        }
        
        .anomaly-card:hover {
            background: #f8f9ff;
            transform: translateX(5px);
        }
        
        .anomaly-card:last-child {
            border-bottom: none;
        }
        
        .anomaly-title {
            font-size: 1.2em;
            font-weight: bold;
            color: #e74c3c;
            margin-bottom: 10px;
        }
        
        .anomaly-details {
            color: #666;
            line-height: 1.5;
        }
        
        .anomaly-type {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 15px;
            font-size: 0.8em;
            font-weight: 500;
            margin-bottom: 10px;
        }
        
        .anomaly-type.frequency { background: #fff3cd; color: #856404; }
        .anomaly-type.spending { background: #d1ecf1; color: #0c5460; }
        .anomaly-type.non-fuel { background: #ffeaa7; color: #d63031; }
        
        .click-hint {
            position: absolute;
            top: 20px;
            right: 20px;
            background: #2196F3;
            color: white;
            padding: 2px 8px;
            border-radius: 10px;
            font-size: 0.7em;
            opacity: 0.8;
        }
        
        .loading {
            text-align: center;
            padding: 40px;
            font-size: 1.2em;
            color: #666;
        }
        
        .loading::after {
            content: '';
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid #3498db;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-left: 10px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .hidden {
            display: none;
        }
        
        .export-btn {
            background: linear-gradient(135deg, #00D2FF, #3A7BD5);
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 25px;
            cursor: pointer;
            margin: 10px;
            transition: all 0.3s ease;
        }
        
        .export-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(0, 210, 255, 0.3);
        }

        /* Modal Styles */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
            animation: fadeIn 0.3s ease;
        }
        
        .modal.active {
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .modal-content {
            background: white;
            border-radius: 20px;
            width: 90%;
            max-width: 1200px;
            max-height: 90vh;
            overflow: hidden;
            position: relative;
            animation: slideIn 0.3s ease;
            box-shadow: 0 20px 40px rgba(0,0,0,0.2);
        }
        
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        
        @keyframes slideIn {
            from { transform: translateY(-50px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }
        
        .modal-header {
            background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%);
            color: white;
            padding: 20px 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .modal-header h2 {
            margin: 0;
            font-size: 1.5em;
        }
        
        .close-btn {
            background: none;
            border: none;
            color: white;
            font-size: 1.5em;
            cursor: pointer;
            padding: 5px 10px;
            border-radius: 50%;
            transition: background 0.3s ease;
        }
        
        .close-btn:hover {
            background: rgba(255,255,255,0.2);
        }
        
        .modal-body {
            padding: 30px;
            max-height: calc(90vh - 100px);
            overflow-y: auto;
        }
        
        .transaction-filters {
            background: #f8f9ff;
            padding: 20px;
            border-radius: 12px;
            margin-bottom: 20px;
            display: flex;
            gap: 20px;
            align-items: center;
            flex-wrap: wrap;
        }
        
        .transaction-filters label {
            font-weight: 600;
            color: #555;
        }
        
        .transaction-filters select,
        .transaction-filters input {
            padding: 8px 12px;
            border: 2px solid #e0e0e0;
            border-radius: 6px;
            font-size: 14px;
        }
        
        .transactions-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
            background: white;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 4px 15px rgba(0,0,0,0.08);
        }
        
        .transactions-table th {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 15px;
            text-align: left;
            font-weight: 600;
        }
        
        .transactions-table td {
            padding: 12px 15px;
            border-bottom: 1px solid #eee;
        }
        
        .transactions-table tr:hover {
            background: #f8f9ff;
        }
        
        .transaction-amount {
            font-weight: bold;
            color: #e74c3c;
        }
        
        .transaction-date {
            font-family: monospace;
            background: #f0f0f0;
            padding: 2px 6px;
            border-radius: 4px;
        }
        
        .anomaly-indicator-small {
            background: #e74c3c;
            color: white;
            padding: 2px 6px;
            border-radius: 10px;
            font-size: 0.7em;
            font-weight: bold;
        }
        
        .transaction-summary {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .summary-card {
            background: #f8f9ff;
            padding: 20px;
            border-radius: 12px;
            text-align: center;
            border-left: 4px solid #2196F3;
        }
        
        .summary-card h3 {
            margin: 0 0 10px 0;
            font-size: 2em;
            color: #2196F3;
        }
        
        .summary-card p {
            margin: 0;
            color: #666;
            font-weight: 500;
        }

        .card-detail-modal .modal-header {
            background: linear-gradient(135deg, #2196F3 0%, #1976D2 100%);
        }

        .period-breakdown {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin: 30px 0;
        }

        .period-card {
            background: white;
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.08);
            border-left: 4px solid #2196F3;
        }

        .period-card h4 {
            color: #2196F3;
            margin-bottom: 15px;
            font-size: 1.2em;
        }

        .period-stats {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
        }

        .period-stat {
            text-align: center;
            padding: 10px;
            background: #f8f9ff;
            border-radius: 8px;
        }

        .period-stat .value {
            font-size: 1.5em;
            font-weight: bold;
            color: #2196F3;
        }

        .period-stat .label {
            font-size: 0.8em;
            color: #666;
            margin-top: 5px;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>Amex Card Usage Pattern Analyzer</h1>
            <p>Detect spending pattern changes and usage anomalies across your business cards</p>
        </div>
        
        <div class="main-content">
            <div class="upload-section" id="uploadSection">
                <h2>Upload Amex CSV Statement</h2>
                <p>Upload multiple months of data for better pattern analysis</p>
                <input type="file" id="fileInput" accept=".csv" />
                <button class="upload-btn" onclick="document.getElementById('fileInput').click()">Choose File</button>
                <p><small>Supports: CSV files from Amex business accounts</small></p>
            </div>
            
            <div class="config-section">
                <h3>‚öôÔ∏è Pattern Analysis Settings</h3>
                <div class="form-group">
                    <label>Frequency Change Sensitivity</label>
                    <select id="frequencyThreshold">
                        <option value="10">High Sensitivity (10%)</option>
                        <option value="25">Medium Sensitivity (25%)</option>
                        <option value="50" selected>Low Sensitivity (50%)</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Spending Change Sensitivity</label>
                    <select id="spendingThreshold">
                        <option value="15">High Sensitivity (15%)</option>
                        <option value="25" selected>Medium Sensitivity (25%)</option>
                        <option value="50">Low Sensitivity (50%)</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Minimum Baseline Period</label>
                    <select id="baselinePeriod">
                        <option value="2">2 weeks</option>
                        <option value="3">3 weeks</option>
                        <option value="4" selected>4 weeks</option>
                        <option value="6">6 weeks</option>
                        <option value="8">8 weeks</option>
                    </select>
                </div>
                <p style="color: #666; margin-top: 10px;">
                    <small>High sensitivity detects smaller changes but may create more alerts | 
                    Low sensitivity only flags major pattern changes | 
                    Baseline period determines minimum data needed for pattern analysis</small>
                </p>
            </div>
            
            <button class="analyze-btn" id="analyzeBtn" onclick="analyzePatterns()" disabled>
                Analyze Card Patterns
            </button>
            
            <div id="loadingDiv" class="loading hidden">
                Analyzing card usage patterns...
            </div>
            
            <div class="results-section" id="resultsSection" style="display: none;">
                <div class="time-period-tabs">
                    <button class="tab active" onclick="showPeriod('weekly')">Weekly View</button>
                    <button class="tab" onclick="showPeriod('monthly')">Monthly View</button>
                </div>
                
                <div class="filter-controls-section">
                    <div class="controls-row">
                        <div class="control-group">
                            <label>Sort by:</label>
                            <select id="sortBy" onchange="applySortAndFilter()">
                                <option value="totalTransactions">Most Transactions</option>
                                <option value="totalAmount">Highest Total Spending</option>
                                <option value="avgWeeklyTransactions">Highest Weekly Activity</option>
                                <option value="avgWeeklySpending">Highest Weekly Spending</option>
                                <option value="avgMonthlyTransactions">Highest Monthly Activity</option>
                                <option value="avgMonthlySpending">Highest Monthly Spending</option>
                                <option value="anomaliesCount">Most Anomalies</option>
                                <option value="cardNumber">Card Number</option>
                            </select>
                        </div>
                        
                        <div class="control-group">
                            <label>Filter by Card:</label>
                            <select id="filterByCard" onchange="applySortAndFilter()">
                                <option value="all">All Cards</option>
                                <!-- Card options will be populated dynamically -->
                            </select>
                        </div>
                        
                        <div class="control-group">
                            <label>Filter by Anomalies:</label>
                            <select id="filterAnomalies" onchange="applySortAndFilter()">
                                <option value="all">All Cards</option>
                                <option value="withAnomalies">Cards with Anomalies</option>
                                <option value="noAnomalies">Cards without Anomalies</option>
                                <option value="highSeverity">High Severity Only</option>
                                <option value="nonFuel">Non-Fuel Purchases</option>
                            </select>
                        </div>
                        
                        <div class="control-group">
                            <label>Spending Range:</label>
                            <input type="range" id="spendingRange" min="0" max="10000" step="100" value="0" oninput="updateSpendingLabel(); applySortAndFilter()">
                            <span id="spendingLabel">$0+</span>
                        </div>
                    </div>
                    
                    <div class="controls-row">
                        <div class="stats-summary">
                            <span id="filteredCount">0</span> of <span id="totalCardsCount">0</span> cards shown
                        </div>
                        <button class="filter-btn" onclick="resetFilters()">Reset All Filters</button>
                    </div>
                </div>
                
                <div id="cardsOverview" class="cards-overview">
                    <!-- Card summaries will be populated here -->
                </div>
                
                <div class="anomalies-section" id="anomaliesSection">
                    <div class="section-header">
                        <h3>üö® Pattern Anomalies Detected</h3>
                        <p style="opacity: 0.9; margin-top: 5px;">Click on any anomaly to see the underlying transaction data</p>
                        <button class="export-btn" onclick="exportAnomalies()">Export Anomalies</button>
                        <button class="export-btn" onclick="exportCardSummary()">Export Card Summary</button>
                    </div>
                    <div id="anomaliesContent">
                        <!-- Anomalies will be populated here -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Anomaly Detail Modal -->
    <div id="anomalyModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="anomalyModalTitle">Anomaly Details</h2>
                <button class="close-btn" onclick="closeAnomalyModal()">&times;</button>
            </div>
            <div class="modal-body">
                <div id="anomalyModalContent">
                    <!-- Content will be populated dynamically -->
                </div>
            </div>
        </div>
    </div>

    <!-- Card Detail Modal -->
    <div id="cardModal" class="modal">
        <div class="modal-content">
            <div class="modal-header card-detail-modal">
                <h2 id="cardModalTitle">Card Details</h2>
                <button class="close-btn" onclick="closeCardModal()">&times;</button>
            </div>
            <div class="modal-body">
                <div id="cardModalContent">
                    <!-- Content will be populated dynamically -->
                </div>
            </div>
        </div>
    </div>

    <script>
        let csvData = [];
        let cardPatterns = {};
        let anomalies = [];
        let currentPeriod = 'weekly';
        let transactionsByCard = {};
        
        // File handling
        const fileInput = document.getElementById('fileInput');
        const uploadSection = document.getElementById('uploadSection');
        const analyzeBtn = document.getElementById('analyzeBtn');
        
        fileInput.addEventListener('change', handleFile);
        
        // Drag and drop
        uploadSection.addEventListener('dragover', (e) => {
            e.preventDefault();
            uploadSection.classList.add('dragover');
        });
        
        uploadSection.addEventListener('dragleave', () => {
            uploadSection.classList.remove('dragover');
        });
        
        uploadSection.addEventListener('drop', (e) => {
            e.preventDefault();
            uploadSection.classList.remove('dragover');
            const files = e.dataTransfer.files;
            if (files.length > 0) {
                handleFile({ target: { files: [files[0]] }});
            }
        });
        
        // Modal controls
        window.onclick = function(event) {
            const anomalyModal = document.getElementById('anomalyModal');
            const cardModal = document.getElementById('cardModal');
            if (event.target === anomalyModal) {
                closeAnomalyModal();
            }
            if (event.target === cardModal) {
                closeCardModal();
            }
        }
        
        function closeAnomalyModal() {
            document.getElementById('anomalyModal').classList.remove('active');
        }
        
        function closeCardModal() {
            document.getElementById('cardModal').classList.remove('active');
        }
        
        function handleFile(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            document.getElementById('loadingDiv').classList.remove('hidden');
            
            Papa.parse(file, {
                header: true,
                dynamicTyping: true,
                skipEmptyLines: true,
                delimitersToGuess: [',', '\t', '|', ';'],
                complete: function(results) {
                    if (results.errors.length > 0) {
                        alert('Error parsing CSV: ' + results.errors[0].message);
                        document.getElementById('loadingDiv').classList.add('hidden');
                        return;
                    }
                    
                    // Clean headers by removing whitespace
                    const cleanedData = results.data.map(row => {
                        const cleanedRow = {};
                        for (let key in row) {
                            const cleanKey = key.trim();
                            cleanedRow[cleanKey] = row[key];
                        }
                        return cleanedRow;
                    });
                    
                    csvData = cleanedData;
                    analyzeBtn.disabled = false;
                    document.getElementById('loadingDiv').classList.add('hidden');
                    
                    // Update upload section
                    const dateRange = getDateRange(csvData);
                    const uniqueCards = getUniqueCardCount(csvData);
                    uploadSection.innerHTML = `
                        <h2>‚úÖ File Loaded: ${file.name}</h2>
                        <p>${csvData.length} transactions from ${dateRange.start} to ${dateRange.end}</p>
                        <p><strong>${uniqueCards} unique cards detected</strong></p>
                        <button class="upload-btn" onclick="document.getElementById('fileInput').click()">Choose Different File</button>
                    `;
                },
                error: function(error) {
                    alert('Error reading file: ' + error.message);
                    document.getElementById('loadingDiv').classList.add('hidden');
                }
            });
        }
        
        function getUniqueCardCount(data) {
            const cards = new Set();
            data.forEach(transaction => {
                const cardNumber = transaction['Account #'] || 'Unknown';
                cards.add(cardNumber);
            });
            return cards.size;
        }
        
        function getDateRange(data) {
            if (!data || data.length === 0) return { start: '', end: '' };
            
            const dates = data.map(row => new Date(row.Date)).filter(d => !isNaN(d));
            if (dates.length === 0) return { start: '', end: '' };
            
            const minDate = new Date(Math.min(...dates));
            const maxDate = new Date(Math.max(...dates));
            
            return {
                start: minDate.toLocaleDateString(),
                end: maxDate.toLocaleDateString()
            };
        }
        
        function analyzePatterns() {
            if (!csvData || csvData.length === 0) {
                alert('Please upload a CSV file first');
                return;
            }
            
            document.getElementById('loadingDiv').classList.remove('hidden');
            cardPatterns = {};
            anomalies = [];
            transactionsByCard = {};
            
            // Get configuration
            const config = {
                frequencyThreshold: parseInt(document.getElementById('frequencyThreshold').value),
                spendingThreshold: parseInt(document.getElementById('spendingThreshold').value),
                baselinePeriod: parseInt(document.getElementById('baselinePeriod').value)
            };
            
            // Group transactions by card
            const cardTransactions = {};
            
            csvData.forEach(transaction => {
                const cardNumber = transaction['Account #'] || 'Unknown';
                const date = new Date(transaction.Date);
                const amount = Math.abs(parseFloat(transaction.Amount) || 0);
                const description = transaction.Description || '';
                
                if (!cardTransactions[cardNumber]) {
                    cardTransactions[cardNumber] = [];
                }
                
                const transactionData = {
                    date: date,
                    amount: amount,
                    description: description,
                    originalData: transaction
                };
                
                cardTransactions[cardNumber].push(transactionData);
            });
            
            // Store transactions by card for detailed views
            transactionsByCard = cardTransactions;
            
            // Analyze each card's patterns
            Object.keys(cardTransactions).forEach(cardNumber => {
                const transactions = cardTransactions[cardNumber].sort((a, b) => a.date - b.date);
                cardPatterns[cardNumber] = analyzeCardPattern(cardNumber, transactions, config);
            });
            
            displayResults();
            document.getElementById('loadingDiv').classList.add('hidden');
        }
        
        function analyzeCardPattern(cardNumber, transactions, config) {
            const pattern = {
                cardNumber: cardNumber,
                totalTransactions: transactions.length,
                totalAmount: transactions.reduce((sum, t) => sum + t.amount, 0),
                dateRange: {
                    start: transactions[0]?.date,
                    end: transactions[transactions.length - 1]?.date
                },
                weeklyData: {},
                monthlyData: {},
                dailyFrequency: {},
                weeklySpending: {},
                anomalies: [],
                anomalyTransactions: {},
                nonFuelTransactions: [],
                fuelTransactions: [],
                nonFuelStats: {
                    count: 0,
                    totalAmount: 0,
                    percentage: 0
                }
            };
            
            // Group by weeks and months
            transactions.forEach(transaction => {
                const date = transaction.date;
                const weekKey = getWeekKey(date);
                const monthKey = getMonthKey(date);
                const dayKey = getDayKey(date);
                
                // Check if transaction is fuel-related
                const isFuelTransaction = isFuelPurchase(transaction);
                if (isFuelTransaction) {
                    pattern.fuelTransactions.push(transaction);
                } else {
                    pattern.nonFuelTransactions.push(transaction);
                    pattern.nonFuelStats.count++;
                    pattern.nonFuelStats.totalAmount += transaction.amount;
                }
                
                // Weekly data
                if (!pattern.weeklyData[weekKey]) {
                    pattern.weeklyData[weekKey] = { transactions: 0, amount: 0, dates: [], transactionDetails: [] };
                }
                pattern.weeklyData[weekKey].transactions++;
                pattern.weeklyData[weekKey].amount += transaction.amount;
                pattern.weeklyData[weekKey].dates.push(date);
                pattern.weeklyData[weekKey].transactionDetails.push(transaction);
                
                // Monthly data
                if (!pattern.monthlyData[monthKey]) {
                    pattern.monthlyData[monthKey] = { transactions: 0, amount: 0, transactionDetails: [] };
                }
                pattern.monthlyData[monthKey].transactions++;
                pattern.monthlyData[monthKey].amount += transaction.amount;
                pattern.monthlyData[monthKey].transactionDetails.push(transaction);
                
                // Daily frequency
                if (!pattern.dailyFrequency[dayKey]) {
                    pattern.dailyFrequency[dayKey] = [];
                }
                pattern.dailyFrequency[dayKey].push(transaction);
                
                // Weekly spending
                if (!pattern.weeklySpending[weekKey]) {
                    pattern.weeklySpending[weekKey] = { amount: 0, transactions: [] };
                }
                pattern.weeklySpending[weekKey].amount += transaction.amount;
                pattern.weeklySpending[weekKey].transactions.push(transaction);
            });
            
            // Calculate non-fuel percentage
            pattern.nonFuelStats.percentage = pattern.totalTransactions > 0 ? 
                (pattern.nonFuelStats.count / pattern.totalTransactions) * 100 : 0;
            
            // Calculate averages for baseline
            const weeklyTransactionCounts = Object.values(pattern.weeklyData).map(w => w.transactions);
            const weeklySpendingAmounts = Object.values(pattern.weeklySpending).map(w => w.amount);
            const dailyFrequencyCounts = Object.values(pattern.dailyFrequency).map(d => d.length);
            
            pattern.averages = {
                weeklyTransactions: weeklyTransactionCounts.reduce((a, b) => a + b, 0) / weeklyTransactionCounts.length,
                weeklySpending: weeklySpendingAmounts.reduce((a, b) => a + b, 0) / weeklySpendingAmounts.length,
                dailyFrequency: dailyFrequencyCounts.reduce((a, b) => a + b, 0) / dailyFrequencyCounts.length
            };
            
            // Detect anomalies if we have enough baseline data
            const weeksOfData = Object.keys(pattern.weeklyData).length;
            if (weeksOfData >= config.baselinePeriod) {
                // Check for frequency anomalies (sudden changes in daily usage)
                Object.keys(pattern.dailyFrequency).forEach(dayKey => {
                    const dayTransactions = pattern.dailyFrequency[dayKey];
                    const dayCount = dayTransactions.length;
                    const expectedCount = Math.round(pattern.averages.dailyFrequency);
                    const changePercent = Math.abs((dayCount - expectedCount) / Math.max(expectedCount, 1) * 100);
                    
                    if (changePercent > config.frequencyThreshold && dayCount > expectedCount) {
                        const anomalyId = `freq_${cardNumber}_${dayKey}`;
                        pattern.anomalies.push({
                            id: anomalyId,
                            type: 'frequency',
                            date: dayKey,
                            message: `Unusual frequency: ${dayCount} transactions on ${dayKey} (average: ${expectedCount.toFixed(1)})`,
                            severity: changePercent > config.frequencyThreshold * 2 ? 'high' : 'medium',
                            changePercent: changePercent,
                            actualValue: dayCount,
                            expectedValue: expectedCount
                        });
                        pattern.anomalyTransactions[anomalyId] = dayTransactions;
                    }
                });
                
                // Check for spending anomalies (changes in weekly spending)
                Object.keys(pattern.weeklySpending).forEach(weekKey => {
                    const weekData = pattern.weeklySpending[weekKey];
                    const weekSpending = weekData.amount;
                    const expectedSpending = pattern.averages.weeklySpending;
                    const changePercent = Math.abs((weekSpending - expectedSpending) / Math.max(expectedSpending, 1) * 100);
                    
                    if (changePercent > config.spendingThreshold) {
                        const anomalyId = `spend_${cardNumber}_${weekKey}`;
                        pattern.anomalies.push({
                            id: anomalyId,
                            type: 'spending',
                            date: weekKey,
                            message: `Spending anomaly: ${weekSpending.toFixed(2)} for week ${weekKey} (average: ${expectedSpending.toFixed(2)})`,
                            severity: changePercent > config.spendingThreshold * 2 ? 'high' : 'medium',
                            changePercent: changePercent,
                            actualValue: weekSpending,
                            expectedValue: expectedSpending
                        });
                        pattern.anomalyTransactions[anomalyId] = weekData.transactions;
                    }
                });
            }
            
            // Add non-fuel anomaly if significant non-fuel spending detected
            if (pattern.nonFuelStats.count > 0) {
                const nonFuelPercentage = pattern.nonFuelStats.percentage;
                if (nonFuelPercentage > 10) { // Flag if more than 10% of transactions are non-fuel
                    const anomalyId = `nonfuel_${cardNumber}`;
                    pattern.anomalies.push({
                        id: anomalyId,
                        type: 'non-fuel',
                        date: 'Multiple',
                        message: `Non-fuel purchases detected: ${pattern.nonFuelStats.count} transactions (${nonFuelPercentage.toFixed(1)}%) totaling ${pattern.nonFuelStats.totalAmount.toFixed(2)}`,
                        severity: nonFuelPercentage > 25 ? 'high' : 'medium',
                        changePercent: nonFuelPercentage,
                        actualValue: pattern.nonFuelStats.count,
                        expectedValue: 0
                    });
                    pattern.anomalyTransactions[anomalyId] = pattern.nonFuelTransactions;
                }
            }
            
            return pattern;
        }
        
        // Function to detect if a transaction is fuel-related
        function isFuelPurchase(transaction) {
            const description = (transaction.description || '').toLowerCase();
            const originalDescription = (transaction.originalData?.Description || '').toLowerCase();
            const merchant = (transaction.originalData?.['Extended Details'] || '').toLowerCase();
            
            // Common fuel-related keywords and gas station brands
            const fuelKeywords = [
                // Generic fuel terms
                'gas', 'fuel', 'gasoline', 'diesel', 'petrol', 'station',
                'exxon', 'mobil', 'shell', 'chevron', 'bp', 'citgo', 'marathon',
                'sunoco', 'valero', 'phillips 66', 'conoco', 'texaco', 'arco',
                'speedway', 'wawa', 'sheetz', 'casey', 'kwik trip', 'holiday',
                'pilot', 'flying j', 'loves', 'ta travel', 'petro',
                'circle k', '7-eleven', 'ampm', 'quick trip', 'quiktrip',
                'racetrac', 'racetrack', 'bucees', 'maverik', 'kum & go',
                'murphy', 'costco gas', 'sams club gas', 'bjs gas',
                // Truck stops and travel centers
                'truck stop', 'travel center', 'travel plaza',
                // Fuel card networks
                'fleet', 'voyager', 'wright express', 'wex', 'fuelman',
                // Gas station numbers/codes
                'pump #', 'pump no', 'island #'
            ];
            
            // Check all text fields for fuel keywords
            const textToCheck = [description, originalDescription, merchant].join(' ');
            
            return fuelKeywords.some(keyword => textToCheck.includes(keyword));
        }
        
        function showAnomalyDetails(cardNumber, anomalyId) {
            const pattern = cardPatterns[cardNumber];
            const anomaly = pattern.anomalies.find(a => a.id === anomalyId);
            const transactions = pattern.anomalyTransactions[anomalyId] || [];
            
            if (!anomaly) return;
            
            const lastFour = cardNumber.toString().slice(-4);
            document.getElementById('anomalyModalTitle').textContent = 
                `Card ****${lastFour} - ${anomaly.type.toUpperCase()} Anomaly`;
            
            const modalContent = document.getElementById('anomalyModalContent');
            
            // Summary section
            const summaryHTML = `
                <div class="transaction-summary">
                    <div class="summary-card">
                        <h3>${transactions.length}</h3>
                        <p>Transactions</p>
                    </div>
                    <div class="summary-card">
                        <h3>${transactions.reduce((sum, t) => sum + t.amount, 0).toFixed(2)}</h3>
                        <p>Total Amount</p>
                    </div>
                    <div class="summary-card">
                        <h3>${anomaly.actualValue.toFixed(anomaly.type === 'spending' ? 2 : 0)}</h3>
                        <p>Actual ${anomaly.type === 'spending' ? 'Spending' : 'Frequency'}</p>
                    </div>
                    <div class="summary-card">
                        <h3>${anomaly.expectedValue.toFixed(anomaly.type === 'spending' ? 2 : 0)}</h3>
                        <p>Expected ${anomaly.type === 'spending' ? 'Spending' : 'Frequency'}</p>
                    </div>
                </div>
                
                <div style="background: #fff3cd; padding: 15px; border-radius: 8px; margin-bottom: 20px; border-left: 4px solid #ffc107;">
                    <strong>Anomaly Details:</strong><br>
                    ${anomaly.message}<br>
                    <strong>Change:</strong> ${anomaly.changePercent.toFixed(1)}% ${anomaly.actualValue > anomaly.expectedValue ? 'increase' : 'decrease'}<br>
                    <strong>Severity:</strong> <span style="color: ${anomaly.severity === 'high' ? '#e74c3c' : '#f39c12'}; font-weight: bold;">${anomaly.severity.toUpperCase()}</span>
                </div>
            `;
            
            // Transaction filters
            const filtersHTML = `
                <div class="transaction-filters">
                    <div>
                        <label>Sort by:</label>
                        <select id="sortTransactions" onchange="updateTransactionDisplay('${anomalyId}')">
                            <option value="date">Date</option>
                            <option value="amount">Amount</option>
                            <option value="description">Description</option>
                        </select>
                    </div>
                    <div>
                        <label>Order:</label>
                        <select id="sortOrder" onchange="updateTransactionDisplay('${anomalyId}')">
                            <option value="desc">Descending</option>
                            <option value="asc">Ascending</option>
                        </select>
                    </div>
                    <div>
                        <label>Min Amount:</label>
                        <input type="number" id="minAmount" placeholder="0" onchange="updateTransactionDisplay('${anomalyId}')" step="0.01">
                    </div>
                </div>
            `;
            
            // Store transactions for filtering
            window.currentAnomalyTransactions = transactions;
            window.currentAnomalyId = anomalyId;
            
            modalContent.innerHTML = summaryHTML + filtersHTML + '<div id="transactionTableContainer"></div>';
            
            // Initial display
            updateTransactionDisplay(anomalyId);
            
            document.getElementById('anomalyModal').classList.add('active');
        }
        
        function updateTransactionDisplay(anomalyId) {
            const transactions = window.currentAnomalyTransactions || [];
            const sortBy = document.getElementById('sortTransactions')?.value || 'date';
            const sortOrder = document.getElementById('sortOrder')?.value || 'desc';
            const minAmount = parseFloat(document.getElementById('minAmount')?.value || 0);
            
            // Filter transactions
            let filteredTransactions = transactions.filter(t => t.amount >= minAmount);
            
            // Sort transactions
            filteredTransactions.sort((a, b) => {
                let valueA, valueB;
                
                switch (sortBy) {
                    case 'date':
                        valueA = a.date;
                        valueB = b.date;
                        break;
                    case 'amount':
                        valueA = a.amount;
                        valueB = b.amount;
                        break;
                    case 'description':
                        valueA = a.description.toLowerCase();
                        valueB = b.description.toLowerCase();
                        break;
                    default:
                        valueA = a.date;
                        valueB = b.date;
                }
                
                if (sortOrder === 'asc') {
                    return valueA > valueB ? 1 : -1;
                } else {
                    return valueA < valueB ? 1 : -1;
                }
            });
            
            // Generate table
            const tableHTML = `
                <table class="transactions-table">
                    <thead>
                        <tr>
                            <th>Type</th>
                            <th>Date</th>
                            <th>Amount</th>
                            <th>Description</th>
                            <th>Reference</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${filteredTransactions.map(transaction => {
                            const isFuel = isFuelPurchase(transaction);
                            const typeIndicator = isFuel ? 
                                '<span style="background: #4CAF50; color: white; padding: 2px 6px; border-radius: 10px; font-size: 0.7em;">‚õΩ FUEL</span>' :
                                '<span style="background: #e67e22; color: white; padding: 2px 6px; border-radius: 10px; font-size: 0.7em;">üö´ NON-FUEL</span>';
                            
                            return `
                                <tr style="${!isFuel ? 'background: #fff5f5;' : ''}">
                                    <td>${typeIndicator}</td>
                                    <td><span class="transaction-date">${transaction.date.toLocaleDateString()}</span></td>
                                    <td><span class="transaction-amount">${transaction.amount.toFixed(2)}</span></td>
                                    <td>${transaction.description}</td>
                                    <td>${transaction.originalData['Reference'] || 'N/A'}</td>
                                </tr>
                            `;
                        }).join('')}
                    </tbody>
                </table>
            `;
            
            document.getElementById('transactionTableContainer').innerHTML = tableHTML;
        }
        
        function showNonFuelTransactions(cardNumber) {
            const pattern = cardPatterns[cardNumber];
            if (!pattern || pattern.nonFuelStats.count === 0) return;
            
            const lastFour = cardNumber.toString().slice(-4);
            document.getElementById('anomalyModalTitle').textContent = 
                `Card ****${lastFour} - Non-Fuel Transactions`;
            
            const modalContent = document.getElementById('anomalyModalContent');
            const transactions = pattern.nonFuelTransactions;
            
            // Summary section
            const summaryHTML = `
                <div class="transaction-summary">
                    <div class="summary-card">
                        <h3>${transactions.length}</h3>
                        <p>Non-Fuel Transactions</p>
                    </div>
                    <div class="summary-card">
                        <h3>${transactions.reduce((sum, t) => sum + t.amount, 0).toFixed(2)}</h3>
                        <p>Total Non-Fuel Amount</p>
                    </div>
                    <div class="summary-card">
                        <h3>${pattern.nonFuelStats.percentage.toFixed(1)}%</h3>
                        <p>Of All Transactions</p>
                    </div>
                    <div class="summary-card">
                        <h3>${(transactions.reduce((sum, t) => sum + t.amount, 0) / transactions.length).toFixed(2)}</h3>
                        <p>Average Amount</p>
                    </div>
                </div>
                
                <div style="background: #ffeaa7; padding: 15px; border-radius: 8px; margin-bottom: 20px; border-left: 4px solid #e67e22;">
                    <strong>‚õΩ Non-Fuel Purchase Alert:</strong><br>
                    This card has ${transactions.length} transactions that appear to be non-fuel purchases, 
                    representing ${pattern.nonFuelStats.percentage.toFixed(1)}% of all activity. 
                    Review these transactions to ensure they are authorized business expenses.
                </div>
            `;
            
            // Transaction filters
            const filtersHTML = `
                <div class="transaction-filters">
                    <div>
                        <label>Sort by:</label>
                        <select id="sortTransactions" onchange="updateNonFuelDisplay('${cardNumber}')">
                            <option value="date">Date</option>
                            <option value="amount">Amount</option>
                            <option value="description">Description</option>
                        </select>
                    </div>
                    <div>
                        <label>Order:</label>
                        <select id="sortOrder" onchange="updateNonFuelDisplay('${cardNumber}')">
                            <option value="desc">Descending</option>
                            <option value="asc">Ascending</option>
                        </select>
                    </div>
                    <div>
                        <label>Min Amount:</label>
                        <input type="number" id="minAmount" placeholder="0" onchange="updateNonFuelDisplay('${cardNumber}')" step="0.01">
                    </div>
                </div>
            `;
            
            // Store transactions for filtering
            window.currentNonFuelTransactions = transactions;
            window.currentNonFuelCard = cardNumber;
            
            modalContent.innerHTML = summaryHTML + filtersHTML + '<div id="transactionTableContainer"></div>';
            
            // Initial display
            updateNonFuelDisplay(cardNumber);
            
            document.getElementById('anomalyModal').classList.add('active');
        }
        
        function updateNonFuelDisplay(cardNumber) {
            const transactions = window.currentNonFuelTransactions || [];
            const sortBy = document.getElementById('sortTransactions')?.value || 'date';
            const sortOrder = document.getElementById('sortOrder')?.value || 'desc';
            const minAmount = parseFloat(document.getElementById('minAmount')?.value || 0);
            
            // Filter transactions
            let filteredTransactions = transactions.filter(t => t.amount >= minAmount);
            
            // Sort transactions
            filteredTransactions.sort((a, b) => {
                let valueA, valueB;
                
                switch (sortBy) {
                    case 'date':
                        valueA = a.date;
                        valueB = b.date;
                        break;
                    case 'amount':
                        valueA = a.amount;
                        valueB = b.amount;
                        break;
                    case 'description':
                        valueA = a.description.toLowerCase();
                        valueB = b.description.toLowerCase();
                        break;
                    default:
                        valueA = a.date;
                        valueB = b.date;
                }
                
                if (sortOrder === 'asc') {
                    return valueA > valueB ? 1 : -1;
                } else {
                    return valueA < valueB ? 1 : -1;
                }
            });
            
            // Generate table with merchant analysis
            const tableHTML = `
                <table class="transactions-table">
                    <thead>
                        <tr>
                            <th>‚ö†Ô∏è Alert</th>
                            <th>Date</th>
                            <th>Amount</th>
                            <th>Description</th>
                            <th>Merchant Category</th>
                            <th>Reference</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${filteredTransactions.map(transaction => {
                            const merchantCategory = categorizeMerchant(transaction);
                            return `
                                <tr style="background: #fff5f5;">
                                    <td><span style="background: #e67e22; color: white; padding: 2px 6px; border-radius: 10px; font-size: 0.7em;">üö´ NON-FUEL</span></td>
                                    <td><span class="transaction-date">${transaction.date.toLocaleDateString()}</span></td>
                                    <td><span class="transaction-amount">${transaction.amount.toFixed(2)}</span></td>
                                    <td style="max-width: 200px; word-wrap: break-word;">${transaction.description}</td>
                                    <td><span style="background: ${merchantCategory.color}; color: white; padding: 2px 6px; border-radius: 8px; font-size: 0.8em;">${merchantCategory.category}</span></td>
                                    <td>${transaction.originalData['Reference'] || 'N/A'}</td>
                                </tr>
                            `;
                        }).join('')}
                    </tbody>
                </table>
                
                <div style="margin-top: 20px; padding: 15px; background: #f8f9ff; border-radius: 8px;">
                    <h4 style="color: #2196F3; margin-bottom: 10px;">üí° Analysis Tips:</h4>
                    <ul style="color: #666; line-height: 1.6;">
                        <li>üîç <strong>Review Merchant Categories:</strong> Look for patterns in non-fuel spending</li>
                        <li>üìÖ <strong>Check Dates:</strong> Identify if non-fuel purchases occur on specific days/times</li>
                        <li>üí∞ <strong>Monitor Amounts:</strong> Large non-fuel transactions may need additional scrutiny</li>
                        <li>üë§ <strong>Verify Authorization:</strong> Ensure all non-fuel purchases are legitimate business expenses</li>
                    </ul>
                </div>
            `;
            
            document.getElementById('transactionTableContainer').innerHTML = tableHTML;
        }
        
        // Function to categorize merchants for better analysis
        function categorizeMerchant(transaction) {
            const description = (transaction.description || '').toLowerCase();
            const originalDescription = (transaction.originalData?.Description || '').toLowerCase();
            const merchant = (transaction.originalData?.['Extended Details'] || '').toLowerCase();
            
            const textToCheck = [description, originalDescription, merchant].join(' ');
            
            // Define merchant categories with colors
            const categories = [
                {
                    category: 'RESTAURANT',
                    color: '#e74c3c',
                    keywords: ['restaurant', 'food', 'dining', 'cafe', 'coffee', 'pizza', 'burger', 'taco', 'subway', 'mcdonalds', 'kfc', 'wendys', 'starbucks', 'dunkin']
                },
                {
                    category: 'RETAIL',
                    color: '#9b59b6',
                    keywords: ['walmart', 'target', 'amazon', 'store', 'shop', 'retail', 'mall', 'market', 'grocery', 'supermarket']
                },
                {
                    category: 'AUTOMOTIVE',
                    color: '#3498db',
                    keywords: ['auto', 'car', 'tire', 'repair', 'service', 'parts', 'mechanic', 'oil change', 'brake', 'automotive']
                },
                {
                    category: 'HOTEL/TRAVEL',
                    color: '#1abc9c',
                    keywords: ['hotel', 'motel', 'inn', 'travel', 'airline', 'airport', 'flight', 'booking', 'resort', 'lodge']
                },
                {
                    category: 'CONVENIENCE',
                    color: '#f39c12',
                    keywords: ['convenience', 'corner', 'quick', 'mini mart', 'bodega', 'variety']
                },
                {
                    category: 'ENTERTAINMENT',
                    color: '#e67e22',
                    keywords: ['movie', 'theater', 'cinema', 'game', 'entertainment', 'amusement', 'recreation']
                },
                {
                    category: 'OFFICE/SUPPLIES',
                    color: '#34495e',
                    keywords: ['office', 'supply', 'depot', 'staples', 'fedex', 'ups', 'print', 'copy']
                },
                {
                    category: 'ATM/CASH',
                    color: '#95a5a6',
                    keywords: ['atm', 'cash', 'withdrawal', 'advance']
                }
            ];
            
            // Check each category
            for (const cat of categories) {
                if (cat.keywords.some(keyword => textToCheck.includes(keyword))) {
                    return cat;
                }
            }
            
            // Default category for unrecognized merchants
            return {
                category: 'OTHER',
                color: '#7f8c8d'
            };
        }
        
        function showCardDetails(cardNumber) {
            const pattern = cardPatterns[cardNumber];
            if (!pattern) return;
            
            const lastFour = cardNumber.toString().slice(-4);
            document.getElementById('cardModalTitle').textContent = `Card ****${lastFour} - Detailed Analysis`;
            
            const transactions = transactionsByCard[cardNumber] || [];
            const modalContent = document.getElementById('cardModalContent');
            
            // Card summary with non-fuel alert
            const summaryHTML = `
                <div class="transaction-summary">
                    <div class="summary-card">
                        <h3>${pattern.totalTransactions}</h3>
                        <p>Total Transactions</p>
                    </div>
                    <div class="summary-card">
                        <h3>${pattern.totalAmount.toFixed(2)}</h3>
                        <p>Total Amount</p>
                    </div>
                    <div class="summary-card">
                        <h3>${pattern.anomalies.length}</h3>
                        <p>Anomalies Detected</p>
                    </div>
                    <div class="summary-card">
                        <h3>${Math.ceil((pattern.dateRange.end - pattern.dateRange.start) / (1000 * 60 * 60 * 24))}</h3>
                        <p>Days Active</p>
                    </div>
                </div>
                
                ${pattern.nonFuelStats.count > 0 ? `
                <div style="background: #ffeaa7; padding: 20px; border-radius: 12px; margin-bottom: 20px; border-left: 4px solid #e67e22;">
                    <h3 style="color: #d63031; margin: 0 0 10px 0;">‚õΩ Non-Fuel Purchase Alert</h3>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px;">
                        <div style="text-align: center;">
                            <div style="font-size: 1.5em; font-weight: bold; color: #d63031;">${pattern.nonFuelStats.count}</div>
                            <div style="color: #666;">Non-Fuel Transactions</div>
                        </div>
                        <div style="text-align: center;">
                            <div style="font-size: 1.5em; font-weight: bold; color: #d63031;">${pattern.nonFuelStats.totalAmount.toFixed(2)}</div>
                            <div style="color: #666;">Non-Fuel Amount</div>
                        </div>
                        <div style="text-align: center;">
                            <div style="font-size: 1.5em; font-weight: bold; color: #d63031;">${pattern.nonFuelStats.percentage.toFixed(1)}%</div>
                            <div style="color: #666;">Of All Transactions</div>
                        </div>
                        <div style="text-align: center;">
                            <button onclick="showNonFuelTransactions('${cardNumber}')" style="background: #d63031; color: white; padding: 8px 16px; border: none; border-radius: 20px; cursor: pointer;">
                                View Details
                            </button>
                        </div>
                    </div>
                </div>
                ` : ''}
            `;
            
            // Period breakdown
            const weeklyPeriods = Object.keys(pattern.weeklyData);
            const monthlyPeriods = Object.keys(pattern.monthlyData);
            
            const periodHTML = `
                <div class="period-breakdown">
                    <div class="period-card">
                        <h4>Weekly Pattern</h4>
                        <div class="period-stats">
                            <div class="period-stat">
                                <div class="value">${weeklyPeriods.length}</div>
                                <div class="label">Weeks</div>
                            </div>
                            <div class="period-stat">
                                <div class="value">${(pattern.totalTransactions / weeklyPeriods.length).toFixed(1)}</div>
                                <div class="label">Avg/Week</div>
                            </div>
                            <div class="period-stat">
                                <div class="value">${(pattern.totalAmount / weeklyPeriods.length).toFixed(0)}</div>
                                <div class="label">Avg Spending</div>
                            </div>
                            <div class="period-stat">
                                <div class="value">${pattern.averages.dailyFrequency.toFixed(1)}</div>
                                <div class="label">Daily Avg</div>
                            </div>
                        </div>
                    </div>
                    <div class="period-card">
                        <h4>Monthly Pattern</h4>
                        <div class="period-stats">
                            <div class="period-stat">
                                <div class="value">${monthlyPeriods.length}</div>
                                <div class="label">Months</div>
                            </div>
                            <div class="period-stat">
                                <div class="value">${(pattern.totalTransactions / monthlyPeriods.length).toFixed(1)}</div>
                                <div class="label">Avg/Month</div>
                            </div>
                            <div class="period-stat">
                                <div class="value">${(pattern.totalAmount / monthlyPeriods.length).toFixed(0)}</div>
                                <div class="label">Avg Spending</div>
                            </div>
                            <div class="period-stat">
                                <div class="value">${(pattern.totalTransactions / Math.ceil((pattern.dateRange.end - pattern.dateRange.start) / (1000 * 60 * 60 * 24))).toFixed(2)}</div>
                                <div class="label">Trans/Day</div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            // Anomalies list
            const anomaliesHTML = pattern.anomalies.length > 0 ? `
                <h3 style="color: #e74c3c; margin: 30px 0 15px 0;">Detected Anomalies</h3>
                <div style="background: #fff5f5; padding: 20px; border-radius: 12px; border-left: 4px solid #e74c3c;">
                    ${pattern.anomalies.map(anomaly => `
                        <div style="margin-bottom: 15px; padding: 10px; background: white; border-radius: 8px; cursor: pointer;" 
                             onclick="showAnomalyDetails('${cardNumber}', '${anomaly.id}')">
                            <div style="font-weight: bold; color: #e74c3c;">${anomaly.type.toUpperCase()} - ${anomaly.severity.toUpperCase()}</div>
                            <div style="color: #666; margin-top: 5px;">${anomaly.message}</div>
                            <div style="font-size: 0.8em; color: #999; margin-top: 5px;">Click to view transaction details</div>
                        </div>
                    `).join('')}
                </div>
            ` : `
                <div style="background: #f0f8f0; padding: 20px; border-radius: 12px; border-left: 4px solid #4CAF50; margin-top: 30px;">
                    <h3 style="color: #4CAF50; margin: 0 0 10px 0;">‚úì No Anomalies Detected</h3>
                    <p style="color: #666; margin: 0;">This card shows consistent usage patterns with no significant deviations.</p>
                </div>
            `;
            
            modalContent.innerHTML = summaryHTML + periodHTML + anomaliesHTML;
            document.getElementById('cardModal').classList.add('active');
        }
        
        function getWeekKey(date) {
            const year = date.getFullYear();
            const week = getWeekNumber(date);
            return `${year}-W${week.toString().padStart(2, '0')}`;
        }
        
        function getMonthKey(date) {
            return `${date.getFullYear()}-${(date.getMonth() + 1).toString().padStart(2, '0')}`;
        }
        
        function getDayKey(date) {
            return date.toISOString().split('T')[0];
        }
        
        function getWeekNumber(date) {
            const firstDayOfYear = new Date(date.getFullYear(), 0, 1);
            const pastDaysOfYear = (date - firstDayOfYear) / 86400000;
            return Math.ceil((pastDaysOfYear + firstDayOfYear.getDay() + 1) / 7);
        }
        
        function displayResults() {
            const resultsSection = document.getElementById('resultsSection');
            
            // Store all card data for filtering
            window.allCardData = Object.values(cardPatterns);
            
            // Populate card filter dropdown
            populateCardFilter();
            
            // Initial display
            applySortAndFilter();
            
            // Display anomalies
            displayAnomalies();
            
            resultsSection.style.display = 'block';
        }
        
        function populateCardFilter() {
            const filterByCard = document.getElementById('filterByCard');
            
            // Clear existing options except "All Cards"
            filterByCard.innerHTML = '<option value="all">All Cards</option>';
            
            // Add option for each card
            window.allCardData.forEach(pattern => {
                const lastFour = pattern.cardNumber.toString().slice(-4);
                const option = document.createElement('option');
                option.value = pattern.cardNumber;
                option.textContent = `Card ****${lastFour}`;
                filterByCard.appendChild(option);
            });
        }
        
        function applySortAndFilter() {
            const sortBy = document.getElementById('sortBy').value;
            const filterByCard = document.getElementById('filterByCard').value;
            const filterAnomalies = document.getElementById('filterAnomalies').value;
            const spendingThreshold = parseInt(document.getElementById('spendingRange').value);
            
            if (!window.allCardData) return;
            
            // Filter cards
            let filteredCards = window.allCardData.filter(pattern => {
                // Card filter
                if (filterByCard !== 'all' && pattern.cardNumber !== filterByCard) {
                    return false;
                }
                
                // Anomalies filter
                if (filterAnomalies !== 'all') {
                    const hasAnomalies = pattern.anomalies.length > 0;
                    const hasHighSeverity = pattern.anomalies.some(a => a.severity === 'high');
                    const hasNonFuel = pattern.nonFuelStats.count > 0;
                    
                    if (filterAnomalies === 'withAnomalies' && !hasAnomalies) return false;
                    if (filterAnomalies === 'noAnomalies' && hasAnomalies) return false;
                    if (filterAnomalies === 'highSeverity' && !hasHighSeverity) return false;
                    if (filterAnomalies === 'nonFuel' && !hasNonFuel) return false;
                }
                
                // Spending filter
                if (pattern.totalAmount < spendingThreshold) return false;
                
                return true;
            });
            
            // Sort cards
            filteredCards.sort((a, b) => {
                switch (sortBy) {
                    case 'totalTransactions':
                        return b.totalTransactions - a.totalTransactions;
                    case 'totalAmount':
                        return b.totalAmount - a.totalAmount;
                    case 'avgWeeklyTransactions':
                        const aWeeklyTrans = Object.keys(a.weeklyData).length > 0 ? a.totalTransactions / Object.keys(a.weeklyData).length : 0;
                        const bWeeklyTrans = Object.keys(b.weeklyData).length > 0 ? b.totalTransactions / Object.keys(b.weeklyData).length : 0;
                        return bWeeklyTrans - aWeeklyTrans;
                    case 'avgWeeklySpending':
                        const aWeeklySpend = Object.keys(a.weeklyData).length > 0 ? a.totalAmount / Object.keys(a.weeklyData).length : 0;
                        const bWeeklySpend = Object.keys(b.weeklyData).length > 0 ? b.totalAmount / Object.keys(b.weeklyData).length : 0;
                        return bWeeklySpend - aWeeklySpend;
                    case 'avgMonthlyTransactions':
                        const aMonthlyTrans = Object.keys(a.monthlyData).length > 0 ? a.totalTransactions / Object.keys(a.monthlyData).length : 0;
                        const bMonthlyTrans = Object.keys(b.monthlyData).length > 0 ? b.totalTransactions / Object.keys(b.monthlyData).length : 0;
                        return bMonthlyTrans - aMonthlyTrans;
                    case 'avgMonthlySpending':
                        const aMonthlySpend = Object.keys(a.monthlyData).length > 0 ? a.totalAmount / Object.keys(a.monthlyData).length : 0;
                        const bMonthlySpend = Object.keys(b.monthlyData).length > 0 ? b.totalAmount / Object.keys(b.monthlyData).length : 0;
                        return bMonthlySpend - aMonthlySpend;
                    case 'anomaliesCount':
                        return b.anomalies.length - a.anomalies.length;
                    case 'cardNumber':
                        return a.cardNumber.localeCompare(b.cardNumber);
                    default:
                        return 0;
                }
            });
            
            // Display filtered and sorted cards
            displayCards(filteredCards);
            
            // Update stats
            document.getElementById('filteredCount').textContent = filteredCards.length;
            document.getElementById('totalCardsCount').textContent = window.allCardData.length;
        }
        
        function displayCards(cardsToShow) {
            const cardsOverview = document.getElementById('cardsOverview');
            
            let cardHTML = '';
            cardsToShow.forEach(pattern => {
                const lastFour = pattern.cardNumber.toString().slice(-4);
                const data = currentPeriod === 'weekly' ? pattern.weeklyData : pattern.monthlyData;
                const periods = Object.keys(data).length;
                const avgAmount = periods > 0 ? pattern.totalAmount / periods : 0;
                const avgTransactions = periods > 0 ? pattern.totalTransactions / periods : 0;
                
                const hasAnomalies = pattern.anomalies.length > 0;
                const hasHighSeverity = pattern.anomalies.some(a => a.severity === 'high');
                const hasNonFuel = pattern.nonFuelStats.count > 0;
                const anomalyClass = hasAnomalies ? 'has-anomalies' : 'no-anomalies';
                
                // Add non-fuel indicator to card display
                const nonFuelIndicator = hasNonFuel ? 
                    `<div style="position: absolute; top: 50px; right: 15px; background: #e67e22; color: white; padding: 2px 6px; border-radius: 10px; font-size: 0.7em;">
                        ‚õΩ ${pattern.nonFuelStats.count} Non-Fuel
                    </div>` : '';
                
                cardHTML += `
                    <div class="card-summary ${anomalyClass}" onclick="showCardDetails('${pattern.cardNumber}')">
                        <div class="anomaly-indicator ${hasAnomalies ? (hasHighSeverity ? '' : 'medium') : 'none'}">
                            ${hasAnomalies ? `${pattern.anomalies.length} Alert${pattern.anomalies.length > 1 ? 's' : ''}` : '‚úì Clean'}
                        </div>
                        ${nonFuelIndicator}
                        <div class="card-number">Card ****${lastFour}</div>
                        <div class="card-stats">
                            <div class="stat-item">
                                <div class="stat-value">${pattern.totalTransactions}</div>
                                <div class="stat-label">Total Transactions</div>
                            </div>
                            <div class="stat-item">
                                <div class="stat-value">${pattern.totalAmount.toFixed(0)}</div>
                                <div class="stat-label">Total Amount</div>
                            </div>
                            <div class="stat-item">
                                <div class="stat-value">${avgTransactions.toFixed(1)}</div>
                                <div class="stat-label">Avg ${currentPeriod.charAt(0).toUpperCase() + currentPeriod.slice(1)} Transactions</div>
                            </div>
                            <div class="stat-item">
                                <div class="stat-value">${avgAmount.toFixed(0)}</div>
                                <div class="stat-label">Avg ${currentPeriod.charAt(0).toUpperCase() + currentPeriod.slice(1)} Spending</div>
                            </div>
                        </div>
                        <div style="text-align: center; margin-top: 10px; font-size: 0.8em; color: #666;">
                            Click to view details
                        </div>
                    </div>
                `;
            });
            cardsOverview.innerHTML = cardHTML;
        }
        
        function displayAnomalies() {
            const anomaliesContent = document.getElementById('anomaliesContent');
            
            let anomaliesHTML = '';
            let totalAnomalies = 0;
            
            Object.values(cardPatterns).forEach(pattern => {
                if (pattern.anomalies.length > 0) {
                    totalAnomalies += pattern.anomalies.length;
                    const lastFour = pattern.cardNumber.toString().slice(-4);
                    
                    pattern.anomalies.forEach(anomaly => {
                        anomaliesHTML += `
                            <div class="anomaly-card" onclick="showAnomalyDetails('${pattern.cardNumber}', '${anomaly.id}')">
                                <div class="click-hint">Click for details</div>
                                <div class="anomaly-type ${anomaly.type}">${anomaly.type.toUpperCase()}</div>
                                <div class="anomaly-title">Card ****${lastFour} - ${anomaly.severity.toUpperCase()} ALERT</div>
                                <div class="anomaly-details">
                                    ${anomaly.message}
                                    <br><strong>Change:</strong> ${anomaly.changePercent.toFixed(1)}% ${anomaly.actualValue > anomaly.expectedValue ? 'increase' : 'decrease'}
                                    <br><em>Click to see the ${pattern.anomalyTransactions[anomaly.id]?.length || 0} underlying transactions</em>
                                </div>
                            </div>
                        `;
                    });
                }
            });
            
            if (totalAnomalies === 0) {
                anomaliesHTML = `
                    <div style="padding: 40px; text-align: center; color: #4CAF50; font-size: 1.2em;">
                        ‚úÖ No pattern anomalies detected! All cards show consistent usage patterns.
                    </div>
                `;
            }
            
            anomaliesContent.innerHTML = anomaliesHTML;
        }
        
        function updateSpendingLabel() {
            const value = document.getElementById('spendingRange').value;
            document.getElementById('spendingLabel').textContent = `${value}+`;
        }
        
        function resetFilters() {
            document.getElementById('sortBy').value = 'totalTransactions';
            document.getElementById('filterByCard').value = 'all';
            document.getElementById('filterAnomalies').value = 'all';
            document.getElementById('spendingRange').value = '0';
            updateSpendingLabel();
            applySortAndFilter();
        }
        
        function showPeriod(period) {
            currentPeriod = period;
            
            // Update tab active state
            document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
            event.target.classList.add('active');
            
            // Refresh display with current filters
            applySortAndFilter();
        }
        
        function exportAnomalies() {
            const exportData = [];
            Object.values(cardPatterns).forEach(pattern => {
                const lastFour = pattern.cardNumber.toString().slice(-4);
                pattern.anomalies.forEach(anomaly => {
                    const transactions = pattern.anomalyTransactions[anomaly.id] || [];
                    exportData.push({
                        'Card': `****${lastFour}`,
                        'Type': anomaly.type,
                        'Severity': anomaly.severity,
                        'Date': anomaly.date,
                        'Details': anomaly.message,
                        'Change %': anomaly.changePercent.toFixed(1),
                        'Actual Value': anomaly.actualValue,
                        'Expected Value': anomaly.expectedValue,
                        'Transaction Count': transactions.length,
                        'Total Amount': transactions.reduce((sum, t) => sum + t.amount, 0).toFixed(2)
                    });
                });
            });
            
            if (exportData.length === 0) {
                alert('No anomalies to export');
                return;
            }
            
            const csv = Papa.unparse(exportData);
            downloadCSV(csv, 'card-pattern-anomalies.csv');
        }
        
        function exportCardSummary() {
            const exportData = [];
            Object.values(cardPatterns).forEach(pattern => {
                const lastFour = pattern.cardNumber.toString().slice(-4);
                const weeklyPeriods = Object.keys(pattern.weeklyData).length;
                const monthlyPeriods = Object.keys(pattern.monthlyData).length;
                
                exportData.push({
                    'Card': `****${lastFour}`,
                    'Total Transactions': pattern.totalTransactions,
                    'Total Amount': pattern.totalAmount.toFixed(2),
                    'Weekly Periods': weeklyPeriods,
                    'Monthly Periods': monthlyPeriods,
                    'Avg Weekly Transactions': weeklyPeriods > 0 ? (pattern.totalTransactions / weeklyPeriods).toFixed(1) : 0,
                    'Avg Weekly Spending': weeklyPeriods > 0 ? (pattern.totalAmount / weeklyPeriods).toFixed(2) : 0,
                    'Avg Monthly Transactions': monthlyPeriods > 0 ? (pattern.totalTransactions / monthlyPeriods).toFixed(1) : 0,
                    'Avg Monthly Spending': monthlyPeriods > 0 ? (pattern.totalAmount / monthlyPeriods).toFixed(2) : 0,
                    'Anomalies Count': pattern.anomalies.length,
                    'High Severity Anomalies': pattern.anomalies.filter(a => a.severity === 'high').length,
                    'Non-Fuel Transactions': pattern.nonFuelStats.count,
                    'Non-Fuel Amount': pattern.nonFuelStats.totalAmount.toFixed(2),
                    'Non-Fuel Percentage': pattern.nonFuelStats.percentage.toFixed(1) + '%'
                });
            });
            
            const csv = Papa.unparse(exportData);
            downloadCSV(csv, 'card-usage-summary.csv');
        }
        
        function downloadCSV(csv, filename) {
            const blob = new Blob([csv], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.setAttribute('hidden', '');
            a.setAttribute('href', url);
            a.setAttribute('download', filename);
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
        }
    </script>
</body>
</html>
